#!/bin/bash

# Exit on error
set -e

# Set DuT directory
dut=libmoon
cd "$dut"

# Local variables
test_name="l2-load-latency-single"

# Get hostname
hostname=$(pos_get_variable hostname)

# Load some variables
port_tx=$(pos_get_variable port/tx --remote)
port_rx=$(pos_get_variable port/rx --remote)
PKT_RATE=$(pos_get_variable pkt_rate --from-loop)
PKT_SIZE=$(pos_get_variable pkt_size --from-loop)

# Define colors and timestamp
yellow="\e[1;33m"
blue="\e[1;34m"
reset="\e[0m"

pos_sync
echo 'Sync done'

echo "Starting test $test_name"

# Run libmoon in the background using pos_run
pos_run "dut-$test_name" -- "./build/$dut" "examples/l2-forward.lua" \
    "$port_tx" "$port_rx"

# Wait for test done signal
pos_sync
echo "Stopped test $test_name"

# Kill the process started with pos_run
# Command/stdout/stderr are uploaded automatically
pos_kill "dut-$test_name"

echo "All done DuT $test_name"
